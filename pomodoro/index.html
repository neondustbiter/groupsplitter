<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neon Frosted Pomodoro</title>
	
  <!-- Fonts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tinycolor/1.4.2/tinycolor.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Poppins:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --accent: #ff8ac9;        /* default accent (pink) */
      --accent-2: #ffb6d6;
      --bg-alpha: 0.15;
      --glass-color: rgba(255,255,255,var(--bg-alpha));
      --text: rgba(255,255,255,0.98);
      --muted: rgba(255,255,255,0.75);
      --card-radius: 24px;
      --glass-blur: 18px;
      --width: 540px;
    }

    /* Reset + base */
    *{box-sizing:border-box}
    html,body{height:100%}
	body {
		font-family: 'Poppins', sans-serif;
		background: linear-gradient(135deg, var(--theme-bg1, #2a0a26), var(--theme-bg2, #0a0817));
		background-attachment: fixed;
		min-height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
		color: var(--text-color, #fff);
		transition: background 1.2s ease, color 0.4s ease;
	}
	
	/* Fix dropdown menu styling */
select {
  appearance: none;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #fff;
  font-family: "Poppins", sans-serif;
  font-size: 1rem;
  padding: 10px 14px;
  border-radius: 12px;
  outline: none;
  cursor: pointer;
  transition: background 0.2s ease, border 0.2s ease;
}

/* Hover + focus */
select:hover,
select:focus {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid var(--accent);
}

/* Dropdown options fix */
option {
  background: rgba(30, 30, 30, 0.8);
  color: #fff;
  font-family: "Poppins", sans-serif;
}

/* Prevent text selection for the whole page */
body {
  user-select: none;
}

/* Optional: allow selection in inputs if needed */
input, textarea {
  user-select: text;
}

	body::before {
		content: "";
		position: fixed;
		inset: 0;
		background: linear-gradient(135deg, var(--theme-color, #ff8fcf), #ffb6d5, #f2b1ff);
		mix-blend-mode: overlay;
		opacity: 0.25;
		background-size: 300% 300%;
		animation: moveGradient 12s ease infinite;
		z-index: -1;
	}
	@keyframes moveGradient {
		0% { background-position: 0% 50%; }
		50% { background-position: 100% 50%; }
		100% { background-position: 0% 50%; }
	}

	.timer-box {
		background: rgba(255, 255, 255, 0.08);
		backdrop-filter: blur(25px) saturate(160%);
		border: 1px solid rgba(255, 255, 255, 0.18);
		border-radius: 30px;
		padding: 2rem;
		box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
		color: #fff;
		text-shadow: 0 0 15px rgba(0,0,0,0.4);
	}
	
	h1, h2, h3, p, span {
		color: rgba(255,255,255,0.92);
		text-shadow: 0 0 10px rgba(0,0,0,0.25);
	}	

    /* optional background image (behind glass) */
    .bg-image {
      position:fixed;
      inset:0;
      background-position:center;
      background-size:cover;
      background-repeat:no-repeat;
      filter: saturate(1.05) contrast(1.02);
      z-index:0;
    }

    /* container */
    .shell{
      position:relative;
      width:var(--width);
      max-width:calc(100% - 48px);
      z-index:2;
    }

    .card {
      position:relative;
      border-radius:var(--card-radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      box-shadow: 0 12px 40px rgba(23, 12, 20, 0.22);
      padding:28px;
      overflow:hidden;
    }

    /* gentle rim glow using accent */
    .card::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius:inherit;
      box-shadow: 0 0 120px 0 var(--accent);
      mix-blend-mode:screen;
      opacity:0.09;
    }

    header.app-header{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:18px;
    }

    .logo {
      width:52px;
      height:52px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display:flex;align-items:center;justify-content:center;
      color:#071022; font-weight:800; font-size:18px; box-shadow:0 6px 18px rgba(0,0,0,0.18);
    }

    h1.app-title{
      font-family:"Poppins", "Inter", sans-serif;
      font-weight:700;
      font-size:20px;
      margin:0;
      line-height:1;
      color:var(--text);
      letter-spacing:-0.02em;
    }
    p.lead{margin:0;color:var(--muted);font-size:13px}

    /* timer big */
    .display {
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      margin-top:8px;
      margin-bottom:6px;
    }
    #bigTimer {
      font-family: "Poppins", sans-serif;
      font-weight:800;
      font-size:84px;
      line-height:0.95;
      color:var(--text);
      text-shadow: 0 6px 28px rgba(0,0,0,0.25), 0 0 30px rgba(255,255,255,0.06);
    }
    #sessionLabel {
      margin-top:6px;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
    }

    /* progress ring (SVG) */
    .ring-wrap{ display:flex; align-items:center; justify-content:center; margin:14px 0 6px; }
    svg.ring { width:148px; height:148px; transform:rotate(-90deg); }
    .center-controls{ position:absolute; left:0; right:0; top:0; bottom:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }

    /* controls */
    .controls { display:flex; gap:10px; justify-content:center; margin-top:16px; flex-wrap:wrap; }
    .btn{
      pointer-events:auto;
      border: none;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#071022;
      padding:10px 16px;
      border-radius:12px;
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(0,0,0,0.18);
      transition: transform .18s ease, box-shadow .18s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform:translateY(-4px); box-shadow:0 18px 34px rgba(0,0,0,0.28) }
    .btn.ghost{
      background: rgba(255,255,255,0.06);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.06);
    }

#siteVolume {
  width: 100%;
  accent-color: var(--accent);
  cursor: pointer;
}

    /* small control row (modes) */
    .modes { display:flex; gap:8px; justify-content:center; margin-top:16px; flex-wrap:wrap;}
    .mode-btn{
      padding:8px 12px; border-radius:10px; background:rgba(255,255,255,0.04); color:var(--muted); border:1px solid rgba(255,255,255,0.02);
      font-weight:700; cursor:pointer;
    }
    .mode-btn.active{ background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#071022 }

    /* quote */
    .quote { margin-top:12px; color:var(--muted); font-style:italic; font-size:13px; text-align:center; }

#previewBtn {
  padding:8px 12px;
  border-radius:10px;
  background:rgba(255,255,255,0.04);
  color:var(--muted);
  border:1px solid rgba(255,255,255,0.02);
  font-weight:700;
  cursor:pointer;
  transition: all 0.2s ease;
}

#previewBtn:hover {
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  color:#071022;
  border-color:rgba(255,255,255,0.05);
}


    /* settings collapsible */
    .settings {
      margin-top:18px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      padding:12px;
      display:none;
    }
    .settings.open { display:block; animation:slideOpen .28s ease; }
    @keyframes slideOpen { from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:none} }

    .setting-row { display:flex; gap:10px; align-items:center; margin:8px 0; }
    .setting-row label{ font-size:13px; color:var(--muted); min-width:110px }

    /* styled select */
    .select {
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      color:var(--text);
      border-radius:10px;
      padding:10px 14px;
      border:1px solid rgba(255,255,255,0.04);
      font-weight:600;
      width:100%;
      box-shadow:inset 0 -6px 16px rgba(0,0,0,0.08);
    }
    .select-wrap{ flex:1; position:relative }
    .select-wrap::after{
      content:"▾";
      position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none; color:var(--muted);
      font-size:12px;
    }

    /* styled file input */
    .file-btn{
      display:inline-flex; align-items:center; gap:10px; justify-content:center;
      padding:8px 12px; border-radius:10px; background:rgba(255,255,255,0.04); color:var(--text);
      border:1px dashed rgba(255,255,255,0.04); cursor:pointer; font-weight:700;
    }
    .file-btn input{ display:none; }

    /* styled color swatches */
    .swatches { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .swatch{ width:38px; height:38px; border-radius:50%; border:2px solid rgba(255,255,255,0.06); cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.18) }
    .swatch:hover{ transform:scale(1.06) }

    /* checkbox style */
    .checkbox{
      display:inline-flex; align-items:center; gap:10px; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.03);
    }

    /* small text */
    .muted { color:var(--muted); font-size:13px; }

    /* responsive */
    @media (max-width:560px){
      :root{ --width:92vw }
      #bigTimer{ font-size:64px }
    }
  </style>
</head>
<body>
  <!-- optional background image element (fills behind glass) -->
  <div id="bgImage" class="bg-image" style="display:none;"></div>

  <div class="shell">
    <div class="card" role="application" aria-label="Pomodoro timer">
      <header class="app-header">
        <div class="logo">ND</div>
        <div>
          <h1 class="app-title">Claudia Pomodoro
          <p class="lead">For studying and stuff</p>
        </div>
      </header>

      <div class="display" aria-live="polite">
        <div id="bigTimer">25:00</div>
        <div id="sessionLabel">Focus • Pomodoro (25/5)</div>
      </div>

      <!-- progress ring -->
      <div class="ring-wrap" aria-hidden="true">
        <svg class="ring" viewBox="0 0 120 120" width="148" height="148">
          <defs>
            <linearGradient id="grad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="var(--accent)"/>
              <stop offset="100%" stop-color="var(--accent-2)"/>
            </linearGradient>
          </defs>
          <circle cx="60" cy="60" r="54" stroke="rgba(255,255,255,0.06)" stroke-width="12" fill="none"></circle>
          <circle id="progressCircle" cx="60" cy="60" r="54" stroke="url(#grad)" stroke-width="12" fill="none" stroke-linecap="round" stroke-dasharray="339.292" stroke-dashoffset="339.292"></circle>
        </svg>
      </div>

      <div class="controls" role="group" aria-label="Timer controls">
        <button id="startBtn" class="btn">Start</button>
        <button id="pauseBtn" class="btn ghost">Pause</button>
        <button id="resetBtn" class="btn ghost">Reset</button>
        <button id="toggleSettingsBtn" class="btn ghost">Settings</button>
      </div>

      <div class="modes" role="tablist" aria-label="Presets">
        <button class="mode-btn active" data-mode="pomodoro">Pomodoro (25/5)</button>
        <button class="mode-btn" data-mode="flowtime">Flowtime (45/15)</button>
        <button class="mode-btn" data-mode="52-17">52/17</button>
        <button class="mode-btn" data-mode="ultradian">90/20</button>
        <button class="mode-btn" data-mode="custom">Custom</button>
      </div>

      <div class="quote" id="quote">"Focus on progress — take small steps."</div>

      <!-- settings (collapsible) -->
      <div class="settings" id="settingsPanel" aria-hidden="true">
        <!-- Theme -->
        <div class="setting-row">
          <label>Theme Accent</label>
          <div class="swatches" id="swatchRow">
            <div class="swatch" data-color="#ff8ac9" style="background:#ff8ac9"></div>
            <div class="swatch" data-color="#9ad3ff" style="background:#9ad3ff"></div>
            <div class="swatch" data-color="#a6f3d6" style="background:#a6f3d6"></div>
            <div class="swatch" data-color="#ffd08a" style="background:#ffd08a"></div>
            <div class="swatch" id="customColorSwatch" title="Custom color"></div>
            <input id="customColor" type="color" style="display:none" />
          </div>
        </div>

        <!-- Ringtone -->
        <div class="setting-row">
          <label>Ringtone</label>
          <div class="select-wrap">
            <select id="ringtoneSelect" class="select" aria-label="Select ringtone">
              <option value="ringtone1.mp3">Sosumi</option>
              <option value="ringtone2.mp3">Doki Doki!</option>
              <option value="ringtone3.mp3">Serenity</option>
              <option value="ringtone4.mp3">Here We Go Again</option>
            </select>
			<button id="previewBtn">Preview</button>
          </div>
        </div>

        <!-- Background music -->
        <div class="setting-row">
          <label>Background Music</label>
          <div style="flex:1;display:flex;gap:8px;flex-direction:column">
            <div class="select-wrap">
              <select id="musicSelect" class="select" aria-label="Select background music">
                <option value="">None</option>
                <option value="music1.mp3">Secunda</option>
                <option value="music2.mp3">Love and Literature</option>
                <option value="music3.mp3">Tifa</option>
              </select>
            </div>
            <label class="file-btn" title="Upload custom music">
              Upload custom
              <input id="musicUpload" type="file" accept="audio/*" />
            </label>
          </div>
        </div>

        <!-- ticking -->
        <div class="setting-row">
          <label>Tick Sound</label>
          <div>
            <label class="checkbox">
              <input id="tickToggle" type="checkbox" />
              <span class="muted">Enable tick (off by default)</span>
            </label>
          </div>
        </div>

        <!-- custom background -->
        <div class="setting-row">
          <label>Background Image</label>
          <div>
            <label class="file-btn">
              Upload background
              <input id="bgUpload" type="file" accept="image/*" />
            </label>
            <div style="height:6px"></div>
            <label class="checkbox"><input id="useDefaultBg" type="checkbox" checked /> <span class="muted">Use default background</span></label>
          </div>
        </div>

        <!-- custom durations (when custom mode) -->
        <div class="setting-row" id="customDurations" style="display:none">
          <label>Durations (min)</label>
          <div style="display:flex;gap:8px">
            <input id="focusMin" type="number" min="1" value="25" style="padding:8px;border-radius:8px;border:none;width:80px" />
            <input id="shortMin" type="number" min="1" value="5" style="padding:8px;border-radius:8px;border:none;width:80px" />
            <input id="longMin" type="number" min="1" value="15" style="padding:8px;border-radius:8px;border:none;width:80px" />
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* =========================
   Pomodoro Timer - Full
   ========================= */

(() => {
  // Elements
  const startBtn = document.getElementById('startBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const toggleSettingsBtn = document.getElementById('toggleSettingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const bigTimer = document.getElementById('bigTimer');
  const sessionLabel = document.getElementById('sessionLabel');
  const modeButtons = Array.from(document.querySelectorAll('.mode-btn'));
  const progressCircle = document.getElementById('progressCircle');
  const quoteEl = document.getElementById('quote');

  const swatches = document.querySelectorAll('.swatch');
  const customColorInput = document.getElementById('customColor');
  const customColorSwatch = document.getElementById('customColorSwatch');

  const ringtoneSelect = document.getElementById('ringtoneSelect');
  const musicSelect = document.getElementById('musicSelect');
  const musicUpload = document.getElementById('musicUpload');
  const tickToggle = document.getElementById('tickToggle');

  const bgUpload = document.getElementById('bgUpload');
  const bgImageEl = document.getElementById('bgImage');
  const useDefaultBg = document.getElementById('useDefaultBg');

  const customDurationsRow = document.getElementById('customDurations');
  const focusMinInput = document.getElementById('focusMin');
  const shortMinInput = document.getElementById('shortMin');
  const longMinInput = document.getElementById('longMin');

  // State
  let preset = 'pomodoro'; // current preset
  let isRunning = false;
  let timerId = null;
  let totalSec = 25*60;   // total for current session
  let remaining = totalSec;
  let isFocus = true;     // focus or break
  let accent = getStored('accent') || '#ff8ac9';
  let bgMusicAudio = null;
  let tickAudio = null;
  let lastTickAt = 0;

  // Progress ring constants
  const R = 54;
  const CIRCUM = 2 * Math.PI * R;
  progressCircle.style.strokeDasharray = CIRCUM;
  progressCircle.style.strokeDashoffset = CIRCUM;

  // sample motivational quotes (cute)
  const quotes = [
    "Small steps. Big progress.",
    "One focused session at a time.",
    "Breathe. Focus. Create.",
    "You got this. 25 minutes, that's all.",
    "Reset, then shine again.",
	"You're doing great.",
	"Make Claudia proud.",
	"Discipline over motivation.",
	"Take a deep breath and keep going.",
	"Progress is progress.",
	"The first step to Mount Everest.",
	"Breath. Begin again.",
"Progress whispers, not shouts.",
"Every minute plants a seed.",
"Quiet focus builds mountains.",
"Rest, then rise.",
"One task, one heartbeat.",
"Small steps shape great paths.",
"Stillness sharpens motion.",
"Work gently, think clearly.",
"The effort is the art.",
"Let calm lead you forward.",
"Focus turns dust to stars.",
"Peace is power in motion.",
"Begin softly.",
"The smallest spark lights a journey.",
"Stay with the rhythm.",
"Use this site if you like kids",
"Even slow water smooths stone.",
"You are building something unseen.",
"Quiet days make strong hearts.",
"Every focus is a promise kept.",
"Steady is beautiful.",
"What you start, shapes you.",
"Time is patient — be the same.",
"Clarity comes through calm.",
"Little by little becomes plenty.",
"Silence the noise, start again.",
"Let the moment stretch.",
"Keep tending your garden.",
"Progress is quiet courage.",
"Simplicity breeds strength.",
"Focus feels like peace.",
"Begin before you’re ready.",
"Each pause refines your pace.",
"What you repeat, becomes you.",
"The gentle ones finish strong.",
"Even clouds move on.",
"Your pace is enough.",
"Stay steady; storms pass.",
"Quiet work builds loud results.",
"Still water runs deep.",
"The path is made by walking.",
"Breathe into your focus.",
"Your calm is your compass.",
"Stay close to what matters.",
"You have time to grow.",
"A soft start is still a start.",
"Focus blooms slowly.",
"Small effort, steady flame.",
"Keep your mind uncluttered.",
"Let today be simple.",
"Be gentle with your pace.",
"Every second can count.",
"Keep creating small order.",
"There is grace in trying.",
"Focus makes light from fog.",
"Work quietly, shine quietly.",
"Your rhythm is enough.",
"Every start is sacred.",
"The present is where it happens.",
"Calm persistence wins.",
"Breathe in discipline.",
"Don’t rush the beauty.",
"Every task deserves your stillness.",
"Rest refines resolve.",
"Step softly, think deeply.",
"Even waiting can grow roots.",
"Patience turns chaos into clarity.",
"Your mind is a calm sea.",
"Little actions ripple wide.",
"Light collects in patient hands.",
"The day bends toward effort.",
"Still hearts move mountains.",
"Work like water.",
"Every pause has purpose.",
"The start is enough.",
"Calm is a kind of strength.",
"Discipline feels like freedom.",
"Softly, steadily, surely.",
"Patience paints progress.",
"Even the moon takes time to rise.",
"Quiet effort is loud inside.",
"Do less, but do it well.",
"Focus is a gentle art.",
"Still air carries far.",
"The small steps count most.",
"You are already in motion.",
"Let the minutes bloom.",
"Clarity begins with calm.",
"Every thought shapes time.",
"Move slow, stay sharp.",
"Quietly, you’re getting there.",
"The work loves patience.",
"Be steady, not swift.",
"Even the tide takes rest.",
"Small lights guide long roads.",
"Give your focus room to breathe.",
"Peaceful effort, powerful change.",
"Begin soft, finish strong.",
"Calm minds create beauty.",
"The quiet work matters most.",
"Stay still, and start again.",
"Nga needs study techniques to pass lmao."
  ];

  // helper: localStorage
  function getStored(key){ try { return localStorage.getItem('pom_' + key); } catch(e){ return null } }
  function setStored(key,val){ try { localStorage.setItem('pom_' + key, val); } catch(e){} }

  // initialize
  function init(){
    applyAccent(accent);
    // swatches setup
    swatches.forEach(s => {
      s.addEventListener('click', e => {
        const color = s.getAttribute('data-color');
        if(color){
          setAccent(color);
        } else {
          // custom
          customColorInput.click();
        }
      });
    });
    customColorInput.addEventListener('input', e => {
      const val = e.target.value;
      customColorSwatch.style.background = val;
      setAccent(val);
    });
    customColorSwatch.style.background = accent;
    customColorInput.value = accent;

    // modes
    modeButtons.forEach(b => {
      b.addEventListener('click', () => {
        modeButtons.forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        preset = b.getAttribute('data-mode');
        onPresetChange(preset);
      });
    });

    // default preset
    onPresetChange('pomodoro');

    // controls
    startBtn.addEventListener('click', onStart);
    pauseBtn.addEventListener('click', onPause);
    resetBtn.addEventListener('click', onReset);
    toggleSettingsBtn.addEventListener('click', () => {
      const open = settingsPanel.classList.toggle('open');
      settingsPanel.setAttribute('aria-hidden', !open);
    });

    // ringtone & music handlers
    ringtoneSelect.addEventListener('change', ()=> setStored('ringtone', ringtoneSelect.value));
    musicSelect.addEventListener('change', onMusicSelect);
    musicUpload.addEventListener('change', onUploadMusic);
    tickToggle.addEventListener('change', ()=> setStored('tick', tickToggle.checked ? '1':'0'));

    // bg image
    bgUpload.addEventListener('change', onUploadBg);
    useDefaultBg.addEventListener('change', onUseDefaultBg);

    // custom durations toggle
    document.querySelectorAll('.mode-btn').forEach(b=>{
      b.addEventListener('click', ()=> {
        if(b.getAttribute('data-mode') === 'custom') customDurationsRow.style.display = 'flex';
        else customDurationsRow.style.display = 'none';
      });
    });
    // custom durations input updates
    [focusMinInput, shortMinInput, longMinInput].forEach(inp=>{
      inp.addEventListener('change', ()=> {
        if(preset === 'custom') setModeCustom();
      });
    });

    // attempt to load default.png if present and useDefaultBg checked
    const defaultUrl = 'default.png';
    checkDefaultImage(defaultUrl).then(exists=>{
      if(exists){
        // if user previously asked to use default, apply
        if(getStored('useDefault') === '1'){
          useDefaultBg.checked = true;
          setBackgroundImage(defaultUrl);
        }
      } else {
        // no default present
      }
    });

    // restore stored settings
    const storedAccent = getStored('accent');
    if(storedAccent){ setAccent(storedAccent) }
    const storedR = getStored('ringtone'); if(storedR) ringtoneSelect.value = storedR;
    const storedMusic = getStored('music'); if(storedMusic) musicSelect.value = storedMusic;
    const storedTick = getStored('tick'); tickToggle.checked = !!storedTick && storedTick==='1';
    const storedBgUse = getStored('useDefault'); if(storedBgUse==='1'){ useDefaultBg.checked=true; checkDefaultImage('default.png').then(ok=>{ if(ok) setBackgroundImage('default.png') }) }

    // choose random quote
    quoteEl.textContent = quotes[Math.floor(Math.random()*quotes.length)];

    updateDisplay();
  }

  // set accent color everywhere
  function setAccent(c){
    accent = c;
    setStored('accent', c);
    applyAccent(c);
  }
  function applyAccent(c) {
  try {
    document.documentElement.style.setProperty('--accent', c);
    const second = shade(c, 20);
    document.documentElement.style.setProperty('--accent-2', second);
	document.documentElement.style.setProperty('--theme-bg1', tinycolor(selectedColor).darken(25).toString());
	document.documentElement.style.setProperty('--theme-bg2', tinycolor(selectedColor).darken(50).toString());

    customColorSwatch.style.background = c;

    document.querySelectorAll('.btn').forEach(b => {
      if (!b.classList.contains('ghost'))
        b.style.boxShadow = `0 12px 30px ${hexToRgba(c, 0.22)}`;
    });

    const stops = document.querySelectorAll('#grad stop');
    if (stops.length >= 2) {
      stops[0].setAttribute('stop-color', c);
      stops[1].setAttribute('stop-color', second);
    }

    document.body.style.background = `linear-gradient(135deg, ${hexToRgba(c, 0.14)}, rgba(255,240,245,0.18) 60%, rgba(255,250,250,0.95) 100%)`;
  } catch (err) {
    console.error('applyAccent failed:', err);
  }
}

  // presets & durations
  function onPresetChange(p){
    preset = p;
    isFocus = true;
    if(p === 'pomodoro'){ totalSec = 25*60; sessionLabel.textContent = 'Focus • Pomodoro (25/5)'; }
    else if(p === 'flowtime'){ totalSec = 45*60; sessionLabel.textContent = 'Focus • Flowtime (45/15)'; }
    else if(p === '52-17'){ totalSec = 52*60; sessionLabel.textContent = 'Focus • 52/17'; }
    else if(p === 'ultradian'){ totalSec = 90*60; sessionLabel.textContent = 'Focus • Ultradian (90/20)'; }
    else if(p === 'custom'){ totalSec = (Number(focusMinInput.value)||25)*60; sessionLabel.textContent = `Focus • Custom (${focusMinInput.value} / ${shortMinInput.value})`; }
    remaining = totalSec;
    updateDisplay();
    updateProgress();
  }

  // custom mode setter
  function setModeCustom(){
    totalSec = (Number(focusMinInput.value)||25)*60;
    remaining = totalSec;
    updateDisplay();
    updateProgress();
  }

  // start/pause/reset handlers
  function onStart(){
    if(isRunning) return;
    isRunning = true;
    if(!tickAudio && tickToggle.checked) initTick();
    timerLoop();
  }

  function onPause(){
    if(!isRunning) return;
    clearTimeout(timerId);
    isRunning = false;
    stopTick();
  }

  function onReset(){
    clearTimeout(timerId);
    isRunning = false;
    if(preset === 'custom') setModeCustom(); else onPresetChange(preset);
    stopTick();
  }

(function() {
  document.addEventListener('DOMContentLoaded', () => {
    const ringtoneSelect = document.getElementById('ringtoneSelect');
    const previewBtn = document.getElementById('previewBtn');

    if (!ringtoneSelect || !previewBtn) return; // safety check

    let previewAudio;

    previewBtn.addEventListener('click', () => {
      if (previewAudio) {
        previewAudio.pause();
        previewAudio.currentTime = 0;
      }

      const selectedRingtone = ringtoneSelect.value;
      previewAudio = new Audio(selectedRingtone);
      previewAudio.play();

      setTimeout(() => {
        if (previewAudio) {
          previewAudio.pause();
          previewAudio.currentTime = 0;
        }
      }, 10000);
    });

    ringtoneSelect.addEventListener('change', () => setStored('ringtone', ringtoneSelect.value));
  });
})();


  function timerLoop(){
    // use setTimeout for more accurate UI updates and avoid drift accumulation
    const tick = () => {
      const now = Date.now();
      remaining = Math.max(0, remaining - 1);
      updateDisplay();
      updateProgress();
      // tick sound if enabled (short beep)
      if(tickToggle.checked){
        try{ tickAudio.currentTime = 0; tickAudio.play().catch(()=>{}); }catch(e){}
      }
      if(remaining <= 0){
        // session end
        playRingtone();
        // auto switch focus/break durations
        if(isFocus){
          // break durations default: short break 5, long break 15 if many cycles (we'll keep simple)
          const breakDur = (preset==='ultradian') ? 20*60 : (preset==='52-17' ? 17*60 : (preset==='flowtime' ? 15*60 : (preset==='pomodoro' ? 5*60 : (Number(shortMinInput.value)||5)*60)));
          remaining = breakDur;
          totalSec = breakDur;
          isFocus = false;
          sessionLabel.textContent = 'Break';
        } else {
          // after break, back to focus
          const focusDur = (preset==='ultradian') ? 90*60 : (preset==='52-17' ? 52*60 : (preset==='flowtime' ? 45*60 : (preset==='pomodoro' ? 25*60 : (Number(focusMinInput.value)||25)*60)));
          remaining = focusDur;
          totalSec = focusDur;
          isFocus = true;
          sessionLabel.textContent = 'Focus';
        }
        updateProgress();
        // continue automatically
        timerId = setTimeout(tick, 1000);
      } else {
        timerId = setTimeout(tick, 1000);
      }
    };
    // start
    timerId = setTimeout(tick, 1000);
  }

  // progress ring update
  function updateProgress(){
    const used = totalSec - remaining;
    const pct = totalSec > 0 ? used / totalSec : 0;
    const offset = CIRCUM * (1 - pct);
    progressCircle.style.strokeDashoffset = offset;
  }

  // update display
  function updateDisplay(){
    const m = Math.floor(remaining/60);
    const s = remaining % 60;
    bigTimer.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  // sound helpers
  function initTick(){
    tickAudio = new Audio('tick.mp3');
    tickAudio.volume = 0.18;
  }
  function stopTick(){
    if(tickAudio){ try{ tickAudio.pause(); tickAudio.currentTime = 0; }catch(e){} }
  }

  function playRingtone(){
    const sel = ringtoneSelect.value || 'ringtone1.mp3';
    const a = new Audio(sel);
    a.volume = 0.9;
    a.play().catch(()=>{});
  }

  function onMusicSelect(e){
    const val = e.target.value;
    setStored('music', val);
    if(bgMusicAudio){
      bgMusicAudio.pause(); bgMusicAudio = null;
    }
    if(val){
      bgMusicAudio = new Audio(val);
      bgMusicAudio.loop = true;
      bgMusicAudio.volume = 0.28;
      bgMusicAudio.play().catch(()=>{});
    }
  }

  function onUploadMusic(e){
    const f = e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    setStored('musicCustom', url);
    if(bgMusicAudio){ bgMusicAudio.pause(); bgMusicAudio = null; }
    bgMusicAudio = new Audio(url); bgMusicAudio.loop=true; bgMusicAudio.volume=0.28; bgMusicAudio.play().catch(()=>{});
  }

  // background image functions
  function onUploadBg(e){
    const f = e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    setBackgroundImage(url);
    setStored('bgCustom', url);
    useDefaultBg.checked = false;
    setStored('useDefault','0');
  }

  // attempt to set default.png if requested
  function onUseDefaultBg(){
    const use = useDefaultBg.checked;
    setStored('useDefault', use ? '1' : '0');
    if(use){
      checkDefaultImage('default.png').then(ok=>{
        if(ok) setBackgroundImage('default.png');
        else { useDefaultBg.checked=false; setStored('useDefault','0'); alert('default.png not found in the folder.'); }
      });
    } else {
      // clear background if none custom stored
      const storedCustom = getStored('bgCustom');
      if(storedCustom) setBackgroundImage(storedCustom);
      else { clearBackgroundImage(); }
    }
  }

  function setBackgroundImage(url){
    bgImageEl.style.backgroundImage = `url("${url}")`;
    bgImageEl.style.display = 'block';
    // subtle overlay to keep frosted effect
    bgImageEl.style.filter = 'blur(6px) saturate(1.05) contrast(1.02)';
  }
  function clearBackgroundImage(){
    bgImageEl.style.display = 'none';
    bgImageEl.style.backgroundImage = '';
  }

  async function checkDefaultImage(url){
    return new Promise(res=>{
      const img = new Image();
      img.onload = ()=> res(true);
      img.onerror = ()=> res(false);
      img.src = url + '?_cache=' + Date.now();
    });
  }

  // util: hex shade/lighten
  function shade(hex, percent){
    // percent 0-100 -> lighten
    const f = hex.slice(1), t = 255, R = parseInt(f.substring(0,2),16), G = parseInt(f.substring(2,4),16), B = parseInt(f.substring(4,6),16);
    const r = Math.round(R + (t-R)*(percent/100));
    const g = Math.round(G + (t-G)*(percent/100));
    const b = Math.round(B + (t-B)*(percent/100));
    return `#${(1<<24|(r<<16)|(g<<8)|b).toString(16).slice(1)}`;
  }
  function hexToRgba(hex,a){
    const f = hex.slice(1), R = parseInt(f.substring(0,2),16), G = parseInt(f.substring(2,4),16), B = parseInt(f.substring(4,6),16);
    return `rgba(${R}, ${G}, ${B}, ${a})`;
  }

  // store accent
  function setStored(k,v){ try{ localStorage.setItem('pom_'+k, v); }catch(e){} }
  function getStored(k){ try{ return localStorage.getItem('pom_'+k); }catch(e){ return null } }

  // load stored music selection and ringtone
  function restoreStored(){
    const r = getStored('ringtone');
    if(r) ringtoneSelect.value = r;
    const m = getStored('music');
    if(m) { musicSelect.value = m; onMusicSelect({target:{value:m}}); }
    const mk = getStored('musicCustom'); if(mk){ musicSelect.value = ''; bgMusicAudio = new Audio(mk); bgMusicAudio.loop=true; bgMusicAudio.volume=0.28; bgMusicAudio.play().catch(()=>{}); }
  }

  // initial setup
  init();
  restoreStored();

  // expose some for debugging (optional)
  window._pom = { setAccent, onPresetChange, start:onStart, pause:onPause, reset:onReset };

})();
</script>
</body>
</html>
